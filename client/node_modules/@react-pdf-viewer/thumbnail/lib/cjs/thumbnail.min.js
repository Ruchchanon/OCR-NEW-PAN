"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-pdf-viewer/core");function n(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var r=n(e),a=function(){return a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},a.apply(this,arguments)},i=function(e){var n=e.getPageIndex,a=e.renderSpinner,i=e.doc,u=r.useState(""),c=u[0],o=u[1],l=t.useIsMounted(),s=r.useRef(),d=t.useIntersectionObserver({onVisibilityChanged:function(e){if(!c&&e.isVisible){var r=d.current;if(r){var a=i.numPages,u=n?n({numPages:a}):0,g=Math.max(0,Math.min(u,a-1));t.getPage(i,g).then((function(e){var t=e.getViewport({scale:1}),n=t.width,a=t.height,i=document.createElement("canvas"),u=i.getContext("2d",{alpha:!1}),c=r.clientWidth,d=r.clientHeight,g=Math.min(c/n,d/a),h=g*n,m=g*a;i.height=m,i.width=h,i.style.opacity="0";var p=e.getViewport({rotation:0,scale:g});s.current=e.render({canvasContext:u,viewport:p}),s.current.promise.then((function(){l.current&&o(i.toDataURL()),i.width=0,i.height=0}),(function(){}))}))}}}});return r.useEffect((function(){return function(){var e;null===(e=s.current)||void 0===e||e.cancel()}}),[]),c?r.createElement("img",{className:"rpv-thumbnail__cover-image","data-testid":"thumbnail__cover-image",src:c}):r.createElement("div",{className:"rpv-thumbnail__cover-loader","data-testid":"thumbnail__cover-loader",ref:d},a?a():r.createElement(t.Spinner,null))},u=function(e){var n=e.getPageIndex,a=e.renderSpinner,u=e.store,c=r.useState(u.get("doc")),o=c[0],l=c[1],s=function(e){l(e)};return r.useEffect((function(){return u.subscribe("doc",s),function(){u.unsubscribe("doc",s)}}),[]),r.createElement("div",{className:"rpv-thumbnail__cover"},o?r.createElement(i,{doc:o,getPageIndex:n,renderSpinner:a}):r.createElement("div",{className:"rpv-thumbnail__cover-loader"},a?a():r.createElement(t.Spinner,null)))},c=function(){return r.createElement(t.Spinner,null)},o=r.createContext({renderSpinner:c}),l=function(e){var n=e.page,a=e.pageHeight,i=e.pageIndex,u=e.pageWidth,c=e.rotation,l=e.thumbnailHeight,s=e.thumbnailWidth,d=e.onRenderCompleted,g=r.useContext(t.LocalizationContext).l10n,h=r.useRef(),m=r.useState(""),p=m[0],f=m[1],b=g&&g.thumbnail?g.thumbnail.thumbnailLabel:"Thumbnail of page {{pageIndex}}";return r.useEffect((function(){var e=h.current;e&&e.cancel();var t=document.createElement("canvas"),r=t.getContext("2d",{alpha:!1}),o=s,l=o/(u/a),g=o/u;t.height=l,t.width=o,t.style.height="".concat(l,"px"),t.style.width="".concat(o,"px");var m=n.getViewport({rotation:c,scale:g});return h.current=n.render({canvasContext:r,viewport:m}),h.current.promise.then((function(){f(t.toDataURL()),d(i)}),(function(){d(i)})),function(){var e;null===(e=h.current)||void 0===e||e.cancel()}}),[c]),p?r.createElement("img",{"aria-label":b.replace("{{pageIndex}}","".concat(i+1)),src:p,height:"".concat(l,"px"),width:"".concat(s,"px")}):r.useContext(o).renderSpinner()},s=function(e){var n=e.doc,a=e.pageHeight,i=e.pageIndex,u=e.pageWidth,c=e.rotation,s=e.shouldRender,d=e.onRenderCompleted,g=e.onVisibilityChanged,h=r.useState({height:a,page:null,viewportRotation:0,width:u}),m=h[0],p=h[1],f=m.page,b=m.height,v=m.width,_=v/b,P=Math.abs(c)%180==0,E=P?100:100/_,x=P?100/_:100;r.useEffect((function(){s&&t.getPage(n,i).then((function(e){var t=e.getViewport({scale:1});p({height:t.height,page:e,viewportRotation:t.rotation,width:t.width})}))}),[s]);var C=(c+m.viewportRotation)%360,I=t.useIntersectionObserver({onVisibilityChanged:function(e){g(i,e)}});return r.createElement("div",{className:"rpv-thumbnail__container","data-testid":"thumbnail__container-".concat(i),ref:I,style:{height:"".concat(x,"px"),width:"".concat(E,"px")}},f?r.createElement(l,{page:f,pageHeight:P?b:v,pageIndex:i,pageWidth:P?v:b,rotation:C,thumbnailHeight:x,thumbnailWidth:E,onRenderCompleted:d}):r.useContext(o).renderSpinner())},d=function(e){var n=e.currentPage,a=e.doc,i=e.pageHeight,u=e.pageWidth,c=e.renderCurrentPageLabel,o=e.renderThumbnailItem,l=e.rotation,d=e.onJumpToPage,g=r.useState([]),h=g[0],m=g[1],p=a.numPages,f=a.loadingTask.docId,b=h.length,v=r.useRef(null),_=r.useRef([]),P=r.useState(n),E=P[0],x=P[1],C=r.useContext(t.ThemeContext).direction===t.TextDirection.RightToLeft,I=r.useState(-1),S=I[0],y=I[1],w=t.useIsMounted(),T=r.useMemo((function(){return Array(p).fill(0).map((function(e,t){return t}))}),[f]),R=r.useMemo((function(){return t.renderQueueService({doc:a,queueName:"thumbnail-list",priority:999})}),[f]);r.useEffect((function(){a.getPageLabels().then((function(e){w.current&&m(e||[])}))}),[f]);var L=function(){if(v.current){var e=_.current,t=E+1;t<e.length&&(E>=0&&e[E].setAttribute("tabindex","-1"),x(t))}},H=function(){if(v.current){var e=_.current,t=E-1;t>=0&&(E>=0&&e[E].setAttribute("tabindex","-1"),x(t))}},k=function(){E>=0&&E<p&&d(E)};t.useIsomorphicLayoutEffect((function(){var e=v.current;e&&(_.current=Array.from(e.querySelectorAll(".rpv-thumbnail__item")))}),[]),r.useEffect((function(){var e=_.current;if(!(0===e.length||E<0||E>e.length)){var t=e[E];t.setAttribute("tabindex","0"),t.focus()}}),[E]),t.useIsomorphicLayoutEffect((function(){var e=v.current;if(e){var t=e.children;n<t.length&&function(e,t){var n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,r=e.clientHeight,a=t.clientHeight;n<0?t.scrollTop+=n:n+r<=a||(t.scrollTop+=n+r-a)}(t.item(n),e)}}),[n]);var N=r.useCallback((function(e){w.current&&(R.markRendered(e),W())}),[f]),O=r.useCallback((function(e,t){R.setVisibility(e,t.isVisible?t.ratio:R.OUT_OF_RANGE_VISIBILITY),W()}),[f]),W=r.useCallback((function(){var e=R.getHighestPriorityPage();e>-1&&(R.markRendering(e),y(e))}),[f]);return r.useEffect((function(){return function(){R.cleanup()}}),[f]),r.createElement("div",{ref:v,"data-testid":"thumbnail__list",className:t.classNames({"rpv-thumbnail__list":!0,"rpv-thumbnail__list--rtl":C}),onKeyDown:function(e){switch(e.key){case"ArrowDown":L();break;case"ArrowUp":H();break;case"Enter":k()}}},T.map((function(e){var g="".concat(a.loadingTask.docId,"___").concat(e),m=b===p?h[e]:"".concat(e+1),f=c?c({currentPage:n,pageIndex:e,numPages:p,pageLabel:m}):m,v=r.createElement(s,{doc:a,pageHeight:i,pageIndex:e,pageWidth:u,rotation:l,shouldRender:S===e,onRenderCompleted:N,onVisibilityChanged:O});return o?o({currentPage:n,key:g,numPages:p,pageIndex:e,renderPageLabel:r.createElement(r.Fragment,null,f),renderPageThumbnail:v,onJumpToPage:function(){return d(e)}}):r.createElement("div",{key:g},r.createElement("div",{className:t.classNames({"rpv-thumbnail__item":!0,"rpv-thumbnail__item--selected":n===e}),role:"button",tabIndex:n===e?0:-1,onClick:function(){return d(e)}},v),r.createElement("div",{"data-testid":"thumbnail__label-".concat(e),className:"rpv-thumbnail__label"},f))})))},g=function(e){var n=e.renderCurrentPageLabel,a=e.renderThumbnailItem,i=e.store,u=r.useState(i.get("doc")),c=u[0],l=u[1],s=r.useState(i.get("currentPage")||0),g=s[0],h=s[1],m=r.useState(i.get("pageHeight")||0),p=m[0],f=m[1],b=r.useState(i.get("pageWidth")||0),v=b[0],_=b[1],P=r.useState(i.get("rotation")||0),E=P[0],x=P[1],C=function(e){h(e)},I=function(e){l(e)},S=function(e){f(e)},y=function(e){_(e)},w=function(e){x(e)};return r.useEffect((function(){return i.subscribe("doc",I),i.subscribe("pageHeight",S),i.subscribe("pageWidth",y),i.subscribe("rotation",w),function(){i.unsubscribe("doc",I),i.unsubscribe("pageHeight",S),i.unsubscribe("pageWidth",y),i.unsubscribe("rotation",w)}}),[]),t.useIsomorphicLayoutEffect((function(){return i.subscribe("currentPage",C),function(){i.unsubscribe("currentPage",C)}}),[]),c?r.createElement(t.LazyRender,{testId:"thumbnail__list-container",attrs:{className:"rpv-thumbnail__list-container"}},r.createElement(d,{currentPage:g,doc:c,pageHeight:p,pageWidth:v,renderCurrentPageLabel:n,renderThumbnailItem:a,rotation:E,onJumpToPage:function(e){var t=i.get("jumpToPage");t&&t(e)}})):r.createElement("div",{"data-testid":"thumbnail-list__loader",className:"rpv-thumbnail__loader"},r.useContext(o).renderSpinner())};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */exports.thumbnailPlugin=function(e){var n=r.useMemo((function(){return t.createStore({})}),[]),i=r.useState(""),l=i[0],s=i[1];return{install:function(e){n.update("jumpToPage",e.jumpToPage)},onDocumentLoad:function(e){s(e.doc.loadingTask.docId),n.update("doc",e.doc)},onViewerStateChange:function(e){return n.update("currentPage",e.pageIndex),n.update("pageHeight",e.pageHeight),n.update("pageWidth",e.pageWidth),e},Cover:function(t){return r.createElement(u,a({},t,{renderSpinner:null==e?void 0:e.renderSpinner,store:n}))},Thumbnails:r.useCallback((function(t){return r.createElement(o.Provider,{value:{renderSpinner:(null==e?void 0:e.renderSpinner)||c}},r.createElement(g,{renderCurrentPageLabel:null==e?void 0:e.renderCurrentPageLabel,renderThumbnailItem:null==t?void 0:t.renderThumbnailItem,store:n}))}),[l])}};
